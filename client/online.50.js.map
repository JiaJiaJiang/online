{"version":3,"file":"online.50.js","sources":["online.js"],"sourcesContent":["/*!\r\n * online\r\n * Copyright(c) 2016 luojia <luojia@luojia.me>\r\n * MIT Licensed\r\n */\r\n\r\n'use strict';\r\nclass Online{\r\n\tconstructor(addr){\r\n\t\tthis.addr=addr;\r\n\t\tthis.groups=new Set();\r\n\t\tthis.on=false;\r\n\t\tthis.waiting=false;\r\n\t\tthis.onOnlineChange=null;\r\n\t\tthis.onData=null;\r\n\t\tthis.onConnected=null;\r\n\t\tthis.pinger=setInterval(()=>{this.opened&&this.ws.send('');},25000);\r\n\t\tthis.user=`${conv(Date.now(),10,62)}-${randomUser()}`;\r\n\t\tthis.ws=null;\r\n\t\tthis.subscribing=false;\r\n\t\tif(window.localStorage){//use stored user sign\r\n\t\t\tvar user=localStorage.getItem('online_user');\r\n\t\t\tif(!user)localStorage.setItem('online_user',this.user);//save the user\r\n\t\t\telse{this.user=user;}//restore the user\r\n\t\t}\r\n\t\tif(addr){\r\n\t\t\tthis.on=true;\r\n\t\t\tthis.connet();\r\n\t\t}\r\n\t}\r\n\tget opened(){return this.ws&&this.ws.readyState===1;}\r\n\tget connected(){return this.ws.connected;}\r\n\tsend(data){\r\n\t\tthis.ws.send(JSON.stringify(data));\r\n\t}\r\n\tenter(name){\r\n\t\tif(typeof name !== 'string')throw('name is not a string:'+name);\r\n\t\tthis.groups.add(name);\r\n\t\tif(this.connected)\r\n\t\t\tthis.send({_:'enter',g:name,u:this.user});\r\n\t\treturn this;\r\n\t}\r\n\tleave(name){\r\n\t\tif(typeof name !== 'string')throw('name is not a string:'+name);\r\n\t\tif(this.connected && this.groups.delete(name)){\r\n\t\t\tthis.send({_:'leave',g:name});\r\n\t\t}\r\n\t\treturn this;\r\n\t}\r\n\tsubscribe(force){\r\n\t\tthis.subscribing=true;\r\n\t\tif(this.connected)\r\n\t\t\tthis.send({_:'sub',opt:'sub',u:this.user});\r\n\t}\r\n\tunsubscribe(){\r\n\t\tthis.subscribing=false;\r\n\t\tif(this.connected)\r\n\t\t\tthis.send({_:'sub',opt:'unsub'});\r\n\t}\r\n\trequestList(){\r\n\t\tthis.send({_:'sub',opt:'list'});\r\n\t}\r\n\tleaveAll(){\r\n\t\tif(this.connected)\r\n\t\t\tfor(let g of this.groups)this.leave(g);\r\n\t\treturn this;\r\n\t}\r\n\t_reportOl(data){\r\n\t\tthis.onOnlineChange&&this.onOnlineChange(data);\r\n\t}\r\n\tconnet(addr){\r\n\t\tthis.waiting=false;\r\n\t\tif(addr)this.addr=addr;\r\n\t\tif(this.on===false)return;\r\n\t\tif(this.opened)return;\r\n\t\tlet ws=this.ws=new WebSocket(this.addr);\r\n\t\tws.onmessage=m=>{\r\n\t\t\tif(m.data==='connected'){\r\n\t\t\t\tws.connected=true;\r\n\t\t\t\tfor(let g of this.groups)this.enter(g);\r\n\t\t\t\tthis.subscribing&&this.subscribe();\r\n\t\t\t\tthis.onConnected&&this.onConnected();\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tlet msg=JSON.parse(m.data);\r\n\t\t\tswitch(msg._){\r\n\t\t\t\tcase 'ol':case 'subol':{\r\n\t\t\t\t\tmsg.c=parseInt(msg.c,32);\r\n\t\t\t\t\tmsg.u=parseInt(msg.u,32);\r\n\t\t\t\t\tthis._reportOl(msg);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tdefault:{\r\n\t\t\t\t\tthis.onData&&this.onData(msg);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tws.onclose=e=>{\r\n\t\t\tif(this.waiting)return;\r\n\t\t\tif(this.connected)for(let g of this.groups)this._reportOl({g:g,c:0,u:0});\r\n\t\t\tthis.ws.connected=false;\r\n\t\t\tthis.waiting=true;\r\n\t\t\tsetTimeout(()=>{this.connet()},5000);\r\n\t\t}\r\n\t\tws.onerror=e=>ws.onclose();\r\n\t\treturn this;\r\n\t}\r\n\tclose(){\r\n\t\tthis.on=false;\r\n\t\tthis.ws.close();\r\n\t\tclearInterval(this.pinger);\r\n\t}\r\n}\r\n\r\nfunction randomUser(){\r\n\treturn conv(Math.round(99999999*Math.random()),10,62);\r\n}\r\n\r\n//gist: https://gist.coding.net/u/luojia/c33a7e50d9634a1d9084ebd71c468114/\r\nfunction conv(n,o,t,olist,tlist){//数,原进制,目标进制[,原数所用字符表,目标字符表]\r\n\tvar dlist='0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ',\r\n\t\ttnum=[],m,negative=((n+='').trim()[0]=='-'),decnum=0;\r\n\tolist||(olist=dlist);\r\n\ttlist||(tlist=dlist);\r\n\tif(negative)n=n.slice(1);\r\n\tfor(var i=n.length;i--;)\r\n\t\tdecnum+=olist.indexOf(n[i])*Math.pow(o,n.length-i-1);\r\n\tfor(;decnum!=0;tnum.unshift(tlist[m])){\r\n\t\tm=decnum%t;\r\n\t\tdecnum=Math.floor(decnum/t);\r\n\t}\r\n\tdecnum&&tnum.unshift(tlist[decnum]);\r\n\treturn (negative?'-':'')+tnum.join('');\r\n}\r\n\r\nexport default Online;"],"names":["Online","constructor","addr","groups","Set","on","waiting","onOnlineChange","onData","onConnected","pinger","setInterval","opened","ws","send","user","conv","Date","now","randomUser","subscribing","window","localStorage","getItem","setItem","connet","readyState","connected","data","JSON","stringify","enter","name","add","_","g","u","leave","delete","subscribe","force","opt","unsubscribe","requestList","leaveAll","_reportOl","WebSocket","onmessage","m","msg","parse","c","parseInt","onclose","e","setTimeout","onerror","close","clearInterval","Math","round","random","n","o","t","olist","tlist","dlist","tnum","negative","trim","decnum","slice","i","length","indexOf","pow","unshift","floor","join"],"mappings":";;;;;;CAAA;CACA;CACA;CACA;CACA;;CAGA,MAAMA,MAAM,CAAA;GACXC,WAAW,CAACC,IAAI,EAAC;KAChB,IAAI,CAACA,IAAI,GAACA,IAAI,CAAA;CACd,IAAA,IAAI,CAACC,MAAM,GAAC,IAAIC,GAAG,EAAE,CAAA;KACrB,IAAI,CAACC,EAAE,GAAC,KAAK,CAAA;KACb,IAAI,CAACC,OAAO,GAAC,KAAK,CAAA;KAClB,IAAI,CAACC,cAAc,GAAC,IAAI,CAAA;KACxB,IAAI,CAACC,MAAM,GAAC,IAAI,CAAA;KAChB,IAAI,CAACC,WAAW,GAAC,IAAI,CAAA;CACrB,IAAA,IAAI,CAACC,MAAM,GAACC,WAAW,CAAC,MAAI;OAAC,IAAI,CAACC,MAAM,IAAE,IAAI,CAACC,EAAE,CAACC,IAAI,CAAC,EAAE,CAAC,CAAA;MAAE,EAAC,KAAK,CAAC,CAAA;CACnE,IAAA,IAAI,CAACC,IAAI,GAAE,GAAEC,IAAI,CAACC,IAAI,CAACC,GAAG,EAAE,EAAC,EAAE,EAAC,EAAE,CAAE,CAAGC,CAAAA,EAAAA,UAAU,EAAG,CAAC,CAAA,CAAA;KACrD,IAAI,CAACN,EAAE,GAAC,IAAI,CAAA;KACZ,IAAI,CAACO,WAAW,GAAC,KAAK,CAAA;KACtB,IAAGC,MAAM,CAACC,YAAY,EAAC;CAAC;CACvB,MAAA,IAAIP,IAAI,GAACO,YAAY,CAACC,OAAO,CAAC,aAAa,CAAC,CAAA;CAC5C,MAAA,IAAG,CAACR,IAAI,EAACO,YAAY,CAACE,OAAO,CAAC,aAAa,EAAC,IAAI,CAACT,IAAI,CAAC,CAAC;YACnD;SAAC,IAAI,CAACA,IAAI,GAACA,IAAI,CAAA;QAAE;CACtB,KAAA;;CACA,IAAA,IAAGb,IAAI,EAAC;OACP,IAAI,CAACG,EAAE,GAAC,IAAI,CAAA;OACZ,IAAI,CAACoB,MAAM,EAAE,CAAA;CACd,KAAA;CACD,GAAA;CACA,EAAA,IAAIb,MAAM,GAAE;KAAC,OAAO,IAAI,CAACC,EAAE,IAAE,IAAI,CAACA,EAAE,CAACa,UAAU,KAAG,CAAC,CAAA;CAAC,GAAA;CACpD,EAAA,IAAIC,SAAS,GAAE;CAAC,IAAA,OAAO,IAAI,CAACd,EAAE,CAACc,SAAS,CAAA;CAAC,GAAA;GACzCb,IAAI,CAACc,IAAI,EAAC;KACT,IAAI,CAACf,EAAE,CAACC,IAAI,CAACe,IAAI,CAACC,SAAS,CAACF,IAAI,CAAC,CAAC,CAAA;CACnC,GAAA;GACAG,KAAK,CAACC,IAAI,EAAC;KACV,IAAG,OAAOA,IAAI,KAAK,QAAQ,EAAC,MAAM,uBAAuB,GAACA,IAAI,CAAA;CAC9D,IAAA,IAAI,CAAC7B,MAAM,CAAC8B,GAAG,CAACD,IAAI,CAAC,CAAA;CACrB,IAAA,IAAG,IAAI,CAACL,SAAS,EAChB,IAAI,CAACb,IAAI,CAAC;CAACoB,MAAAA,CAAC,EAAC,OAAO;CAACC,MAAAA,CAAC,EAACH,IAAI;OAACI,CAAC,EAAC,IAAI,CAACrB,IAAAA;CAAI,KAAC,CAAC,CAAA;CAC1C,IAAA,OAAO,IAAI,CAAA;CACZ,GAAA;GACAsB,KAAK,CAACL,IAAI,EAAC;KACV,IAAG,OAAOA,IAAI,KAAK,QAAQ,EAAC,MAAM,uBAAuB,GAACA,IAAI,CAAA;CAC9D,IAAA,IAAG,IAAI,CAACL,SAAS,IAAI,IAAI,CAACxB,MAAM,CAACmC,MAAM,CAACN,IAAI,CAAC,EAAC;OAC7C,IAAI,CAAClB,IAAI,CAAC;CAACoB,QAAAA,CAAC,EAAC,OAAO;CAACC,QAAAA,CAAC,EAACH,IAAAA;CAAI,OAAC,CAAC,CAAA;CAC9B,KAAA;CACA,IAAA,OAAO,IAAI,CAAA;CACZ,GAAA;GACAO,SAAS,CAACC,KAAK,EAAC;KACf,IAAI,CAACpB,WAAW,GAAC,IAAI,CAAA;CACrB,IAAA,IAAG,IAAI,CAACO,SAAS,EAChB,IAAI,CAACb,IAAI,CAAC;CAACoB,MAAAA,CAAC,EAAC,KAAK;CAACO,MAAAA,GAAG,EAAC,KAAK;OAACL,CAAC,EAAC,IAAI,CAACrB,IAAAA;CAAI,KAAC,CAAC,CAAA;CAC5C,GAAA;CACA2B,EAAAA,WAAW,GAAE;KACZ,IAAI,CAACtB,WAAW,GAAC,KAAK,CAAA;CACtB,IAAA,IAAG,IAAI,CAACO,SAAS,EAChB,IAAI,CAACb,IAAI,CAAC;CAACoB,MAAAA,CAAC,EAAC,KAAK;CAACO,MAAAA,GAAG,EAAC,OAAA;CAAO,KAAC,CAAC,CAAA;CAClC,GAAA;CACAE,EAAAA,WAAW,GAAE;KACZ,IAAI,CAAC7B,IAAI,CAAC;CAACoB,MAAAA,CAAC,EAAC,KAAK;CAACO,MAAAA,GAAG,EAAC,MAAA;CAAM,KAAC,CAAC,CAAA;CAChC,GAAA;CACAG,EAAAA,QAAQ,GAAE;CACT,IAAA,IAAG,IAAI,CAACjB,SAAS,EAChB,KAAI,IAAIQ,CAAC,IAAI,IAAI,CAAChC,MAAM,EAAC,IAAI,CAACkC,KAAK,CAACF,CAAC,CAAC,CAAA;CACvC,IAAA,OAAO,IAAI,CAAA;CACZ,GAAA;GACAU,SAAS,CAACjB,IAAI,EAAC;KACd,IAAI,CAACrB,cAAc,IAAE,IAAI,CAACA,cAAc,CAACqB,IAAI,CAAC,CAAA;CAC/C,GAAA;GACAH,MAAM,CAACvB,IAAI,EAAC;KACX,IAAI,CAACI,OAAO,GAAC,KAAK,CAAA;CAClB,IAAA,IAAGJ,IAAI,EAAC,IAAI,CAACA,IAAI,GAACA,IAAI,CAAA;CACtB,IAAA,IAAG,IAAI,CAACG,EAAE,KAAG,KAAK,EAAC,OAAA;KACnB,IAAG,IAAI,CAACO,MAAM,EAAC,OAAA;CACf,IAAA,IAAIC,EAAE,GAAC,IAAI,CAACA,EAAE,GAAC,IAAIiC,SAAS,CAAC,IAAI,CAAC5C,IAAI,CAAC,CAAA;CACvCW,IAAAA,EAAE,CAACkC,SAAS,GAACC,CAAC,IAAE;CACf,MAAA,IAAGA,CAAC,CAACpB,IAAI,KAAG,WAAW,EAAC;SACvBf,EAAE,CAACc,SAAS,GAAC,IAAI,CAAA;CACjB,QAAA,KAAI,IAAIQ,CAAC,IAAI,IAAI,CAAChC,MAAM,EAAC,IAAI,CAAC4B,KAAK,CAACI,CAAC,CAAC,CAAA;CACtC,QAAA,IAAI,CAACf,WAAW,IAAE,IAAI,CAACmB,SAAS,EAAE,CAAA;CAClC,QAAA,IAAI,CAAC9B,WAAW,IAAE,IAAI,CAACA,WAAW,EAAE,CAAA;CACpC,QAAA,OAAA;CACD,OAAA;OACA,IAAIwC,GAAG,GAACpB,IAAI,CAACqB,KAAK,CAACF,CAAC,CAACpB,IAAI,CAAC,CAAA;OAC1B,QAAOqB,GAAG,CAACf,CAAC;CACX,QAAA,KAAK,IAAI,CAAA;CAAC,QAAA,KAAK,OAAO;CAAC,UAAA;aACtBe,GAAG,CAACE,CAAC,GAACC,QAAQ,CAACH,GAAG,CAACE,CAAC,EAAC,EAAE,CAAC,CAAA;aACxBF,GAAG,CAACb,CAAC,GAACgB,QAAQ,CAACH,GAAG,CAACb,CAAC,EAAC,EAAE,CAAC,CAAA;CACxB,YAAA,IAAI,CAACS,SAAS,CAACI,GAAG,CAAC,CAAA;CACnB,YAAA,MAAA;CACD,WAAA;CACA,QAAA;CAAQ,UAAA;aACP,IAAI,CAACzC,MAAM,IAAE,IAAI,CAACA,MAAM,CAACyC,GAAG,CAAC,CAAA;CAC7B,YAAA,MAAA;CACD,WAAA;CAAC,OAAA;MAEF,CAAA;CACDpC,IAAAA,EAAE,CAACwC,OAAO,GAACC,CAAC,IAAE;OACb,IAAG,IAAI,CAAChD,OAAO,EAAC,OAAA;CAChB,MAAA,IAAG,IAAI,CAACqB,SAAS,EAAC,KAAI,IAAIQ,CAAC,IAAI,IAAI,CAAChC,MAAM,EAAC,IAAI,CAAC0C,SAAS,CAAC;CAACV,QAAAA,CAAC,EAACA,CAAC;CAACgB,QAAAA,CAAC,EAAC,CAAC;CAACf,QAAAA,CAAC,EAAC,CAAA;CAAC,OAAC,CAAC,CAAA;CACxE,MAAA,IAAI,CAACvB,EAAE,CAACc,SAAS,GAAC,KAAK,CAAA;OACvB,IAAI,CAACrB,OAAO,GAAC,IAAI,CAAA;CACjBiD,MAAAA,UAAU,CAAC,MAAI;SAAC,IAAI,CAAC9B,MAAM,EAAE,CAAA;QAAC,EAAC,IAAI,CAAC,CAAA;MACpC,CAAA;KACDZ,EAAE,CAAC2C,OAAO,GAACF,CAAC,IAAEzC,EAAE,CAACwC,OAAO,EAAE,CAAA;CAC1B,IAAA,OAAO,IAAI,CAAA;CACZ,GAAA;CACAI,EAAAA,KAAK,GAAE;KACN,IAAI,CAACpD,EAAE,GAAC,KAAK,CAAA;CACb,IAAA,IAAI,CAACQ,EAAE,CAAC4C,KAAK,EAAE,CAAA;CACfC,IAAAA,aAAa,CAAC,IAAI,CAAChD,MAAM,CAAC,CAAA;CAC3B,GAAA;CACD,CAAA;CAEA,SAASS,UAAU,GAAE;CACpB,EAAA,OAAOH,IAAI,CAAC2C,IAAI,CAACC,KAAK,CAAC,QAAQ,GAACD,IAAI,CAACE,MAAM,EAAE,CAAC,EAAC,EAAE,EAAC,EAAE,CAAC,CAAA;CACtD,CAAA;;CAEA;CACA,SAAS7C,IAAI,CAAC8C,CAAC,EAACC,CAAC,EAACC,CAAC,EAACC,KAAK,EAACC,KAAK,EAAC;CAAC;GAChC,IAAIC,KAAK,GAAC,gEAAgE;CACzEC,IAAAA,IAAI,GAAC,EAAE;KAACpB,CAAC;CAACqB,IAAAA,QAAQ,GAAE,CAACP,CAAC,IAAE,EAAE,EAAEQ,IAAI,EAAE,CAAC,CAAC,CAAC,IAAE,GAAI;CAACC,IAAAA,MAAM,GAAC,CAAC,CAAA;CACrDN,EAAAA,KAAK,KAAGA,KAAK,GAACE,KAAK,CAAC,CAAA;CACpBD,EAAAA,KAAK,KAAGA,KAAK,GAACC,KAAK,CAAC,CAAA;GACpB,IAAGE,QAAQ,EAACP,CAAC,GAACA,CAAC,CAACU,KAAK,CAAC,CAAC,CAAC,CAAA;CACxB,EAAA,KAAI,IAAIC,CAAC,GAACX,CAAC,CAACY,MAAM,EAACD,CAAC,EAAE,GACrBF,MAAM,IAAEN,KAAK,CAACU,OAAO,CAACb,CAAC,CAACW,CAAC,CAAC,CAAC,GAACd,IAAI,CAACiB,GAAG,CAACb,CAAC,EAACD,CAAC,CAACY,MAAM,GAACD,CAAC,GAAC,CAAC,CAAC,CAAA;CACrD,EAAA,OAAKF,MAAM,IAAE,CAAC,EAACH,IAAI,CAACS,OAAO,CAACX,KAAK,CAAClB,CAAC,CAAC,CAAC,EAAC;KACrCA,CAAC,GAACuB,MAAM,GAACP,CAAC,CAAA;KACVO,MAAM,GAACZ,IAAI,CAACmB,KAAK,CAACP,MAAM,GAACP,CAAC,CAAC,CAAA;CAC5B,GAAA;GACAO,MAAM,IAAEH,IAAI,CAACS,OAAO,CAACX,KAAK,CAACK,MAAM,CAAC,CAAC,CAAA;CACnC,EAAA,OAAO,CAACF,QAAQ,GAAC,GAAG,GAAC,EAAE,IAAED,IAAI,CAACW,IAAI,CAAC,EAAE,CAAC,CAAA;CACvC;;;;;;;;"}